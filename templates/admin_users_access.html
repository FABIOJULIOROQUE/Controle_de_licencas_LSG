<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Gerenciar Acessos - {{ usuario_nome }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
  <h1>Gerenciar Acessos para {{ usuario_nome }}</h1>

  <form method="post">

    <!-- ðŸ”¹ Filtros -->
    <div class="card shadow mb-3">
      <div class="card-body">
        <h5 class="card-title">Filtros AutomÃ¡ticos</h5>
        <div class="row">
          <div class="col-md-4">
            <label for="repSelect" class="form-label">Representante</label>
            <select id="repSelect" class="form-select">
              <option value="">-- Selecione --</option>
              {% set reps = [] %}
              {% for lic in licencas %}
                {% if lic[4] not in reps %}
                  <option value="{{ lic[4] }}">{{ lic[4] }}</option>
                  {% set _ = reps.append(lic[4]) %}
                {% endif %}
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label for="estadoSelect" class="form-label">Estado</label>
            <select id="estadoSelect" class="form-select" disabled>
              <option value="">-- Selecione --</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="cidadeSelect" class="form-label">Cidade</label>
            <select id="cidadeSelect" class="form-select" disabled>
              <option value="">-- Selecione --</option>
            </select>
          </div>
        </div>
        <button type="button" id="btnAplicarFiltro" class="btn btn-primary mt-3">Aplicar Filtro</button>
      </div>
    </div>

    <!-- ðŸ”¹ LicenÃ§as -->
    <div class="card shadow mb-3">
      <div class="card-body">
        <h5 class="card-title">LicenÃ§as</h5>
        <div id="licencasLista" style="max-height:300px; overflow-y:auto;">
          {% for lic in licencas %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="licencas" value="{{ lic[0] }}"
                     id="lic{{ lic[0] }}" {% if lic[0] in licencas_user %}checked{% endif %}>
              <label class="form-check-label" for="lic{{ lic[0] }}">
                [{{ lic[0] }}] {{ lic[1] }} â€” {{ lic[2] }} â€” {{ lic[3] }} ({{ lic[5] }}/{{ lic[6] }})
              </label>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- ðŸ”¹ Cidades -->
    <div class="card shadow mb-3">
      <div class="card-body">
        <h5 class="card-title">Cidades</h5>
        <div id="cidadesLista">
          {% for est, cid in cidades_user %}
            <div class="input-group mb-2">
              <span class="input-group-text">{{ est }}</span>
              <input type="text" class="form-control" name="cidades[]" value="{{ est }}|{{ cid }}">
            </div>
          {% endfor %}
        </div>
        <button type="button" id="btnAddCidade" class="btn btn-sm btn-success">+ Adicionar Cidade</button>
      </div>
    </div>

    <!-- ðŸ”¹ BotÃµes -->
    <button type="submit" class="btn btn-primary">Salvar Acessos</button>
    <a href="{{ url_for('admin_users') }}" class="btn btn-secondary">Cancelar</a>
  </form>
</div>

<script>
const licencasData = {{ licencas | tojson }};

const repSelect = document.getElementById("repSelect");
const estadoSelect = document.getElementById("estadoSelect");
const cidadeSelect = document.getElementById("cidadeSelect");

// Quando escolher representante â†’ popula estados
repSelect.addEventListener("change", () => {
  estadoSelect.innerHTML = '<option value="">-- Selecione --</option>';
  cidadeSelect.innerHTML = '<option value="">-- Selecione --</option>';
  cidadeSelect.disabled = true;

  const rep = repSelect.value;
  if (!rep) {
    estadoSelect.disabled = true;
    return;
  }

  const estados = [...new Set(licencasData.filter(l => l[4] === rep).map(l => l[5]))];
  estados.forEach(e => {
    if (e) {
      const opt = document.createElement("option");
      opt.value = e;
      opt.textContent = e;
      estadoSelect.appendChild(opt);
    }
  });

  estadoSelect.disabled = false;
});

// Quando escolher estado â†’ popula cidades
estadoSelect.addEventListener("change", () => {
  cidadeSelect.innerHTML = '<option value="">-- Selecione --</option>';

  const rep = repSelect.value;
  const estado = estadoSelect.value;
  if (!estado) {
    cidadeSelect.disabled = true;
    return;
  }

  const cidades = [...new Set(licencasData.filter(l => l[4] === rep && l[5] === estado).map(l => l[6]))];
  cidades.forEach(c => {
    if (c) {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      cidadeSelect.appendChild(opt);
    }
  });

  cidadeSelect.disabled = false;
});

// Aplicar filtro â†’ marca licenÃ§as
document.getElementById("btnAplicarFiltro").addEventListener("click", function() {
  const rep = repSelect.value;
  const estado = estadoSelect.value;
  const cidade = cidadeSelect.value;

  if (!rep && !estado && !cidade) {
    alert("Selecione ao menos um filtro.");
    return;
  }

  const url = `/licencas_por_filtro?rep=${encodeURIComponent(rep)}&estado=${encodeURIComponent(estado)}&cidade=${encodeURIComponent(cidade)}`;

  fetch(url)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert("Erro: " + data.error);
        return;
      }
      // Desmarcar todos
      document.querySelectorAll("#licencasLista input[type=checkbox]").forEach(cb => cb.checked = false);

      // Marcar retornados
      data.forEach(lic => {
        const cb = document.getElementById("lic" + lic.id);
        if (cb) cb.checked = true;
      });
    });
});

// Adicionar novo campo cidade
document.getElementById("btnAddCidade").addEventListener("click", function() {
  const div = document.createElement("div");
  div.className = "input-group mb-2";
  div.innerHTML = `
    <span class="input-group-text">UF</span>
    <input type="text" class="form-control" name="cidades[]" placeholder="UF|Cidade">
  `;
  document.getElementById("cidadesLista").appendChild(div);
});
</script>

</body>
</html>
